name: Salesforce Promotion Delta Pipeline

on:
  push:
    branches:
      - qa
      - sit
      - uat
      - main
  pull_request:
    branches:
      - qa
      - sit
      - uat
      - main
    paths:
      - "force-app/**"

jobs:
  quality-gate:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout full history (delta needs this)
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ Setup Node
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # 3Ô∏è‚É£ Install Salesforce CLI
      - name: Install Salesforce CLI
        run: |
          npm install -g @salesforce/cli
          sf --version

      # 4Ô∏è‚É£ Allow unsigned plugins
      - name: Allow delta plugin
        run: |
          mkdir -p ~/.config/sf
          echo '["sfdx-git-delta"]' > ~/.config/sf/unsignedPluginAllowList.json

      # 5Ô∏è‚É£ Install sfdx-git-delta
      - name: Install delta plugin
        run: |
          sf plugins install sfdx-git-delta
          sf plugins | grep sfdx-git-delta

      # 6Ô∏è‚É£ Resolve commit range (PR vs PUSH)
      - name: Resolve commit range
        id: commits
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "FROM=${{ github.event.pull_request.base.sha }}" >> $GITHUB_OUTPUT
            echo "TO=${{ github.event.pull_request.head.sha }}" >> $GITHUB_OUTPUT
          else
            echo "FROM=$(git rev-parse HEAD~1)" >> $GITHUB_OUTPUT
            echo "TO=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          fi

      # 7Ô∏è‚É£ Generate delta
      - name: Generate delta
        run: |
          mkdir -p delta
          sf sgd source delta \
            --from "${{ steps.commits.outputs.FROM }}" \
            --to "${{ steps.commits.outputs.TO }}" \
            --source force-app \
            --output delta \
            --generate-delta

      # 8Ô∏è‚É£ If no delta, skip
      - name: Check delta content
        run: |
          if [ ! -d "delta/force-app" ]; then
            echo "No Salesforce changes detected. Skipping."
            exit 0
          fi

      # 9Ô∏è‚É£ Soft check package.xml (NO FAIL)
      - name: Validate package.xml (soft)
        run: |
          if ! grep -q "<types>" delta/package/package.xml; then
            echo "Warning: package.xml has no <types>. Continuing."
          fi

      # üîü Install PMD
      - name: Install PMD
        run: |
          curl -L -o pmd.zip https://github.com/pmd/pmd/releases/download/pmd_releases%2F7.7.0/pmd-dist-7.7.0-bin.zip
          unzip -q pmd.zip

      # 1Ô∏è‚É£1Ô∏è‚É£ Run PMD
      - name: Run PMD scan
        run: |
          ./pmd-bin-7.7.0/bin/pmd check \
            --dir delta/force-app \
            --rulesets category/apex/design.xml \
            --no-fail-on-violation

      # 1Ô∏è‚É£2Ô∏è‚É£ Decide test level (VALIDATE COMMAND RULES)
      - name: Decide test level
        id: tests
        run: |
          if [ "${GITHUB_REF_NAME}" = "uat" ] || [ "${GITHUB_REF_NAME}" = "main" ]; then
            echo "LEVEL=RunSpecifiedTests" >> $GITHUB_OUTPUT
          else
            echo "LEVEL=RunLocalTests" >> $GITHUB_OUTPUT
          fi

      # 1Ô∏è‚É£3Ô∏è‚É£ Validation deploy
      - name: Validate deployment
        run: |
          sf project deploy validate \
            --source-dir delta/force-app \
            --test-level ${{ steps.tests.outputs.LEVEL }}

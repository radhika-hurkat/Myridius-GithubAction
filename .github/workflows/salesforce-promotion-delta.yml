name: Salesforce Promotion Delta Pipeline

on:
  push:
    branches: [qa, sit, uat, main]
  pull_request:
    branches: [qa, sit, uat, main]
    paths:
      - "force-app/**"

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repo (full history for delta)
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ Setup Node
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # 3Ô∏è‚É£ Install Salesforce CLI
      - name: Install Salesforce CLI
        run: |
          npm install -g @salesforce/cli
          sf --version

      # 4Ô∏è‚É£ Allow sfdx-git-delta plugin
      - name: Allow sfdx-git-delta plugin
        run: |
          mkdir -p ~/.config/sf
          echo '["sfdx-git-delta"]' > ~/.config/sf/unsignedPluginAllowList.json

      # 5Ô∏è‚É£ Install sfdx-git-delta
      - name: Install sfdx-git-delta
        run: |
          sf plugins install sfdx-git-delta

      # 6Ô∏è‚É£ Map branch ‚Üí target org
      - name: Set target org & auth
        run: |
          if [ "${GITHUB_REF_NAME}" = "qa" ]; then
            echo "TARGET_ORG=qa" >> $GITHUB_ENV
            echo "SF_AUTH_URL=${{ secrets.SF_QA_AUTH_URL }}" >> $GITHUB_ENV
          elif [ "${GITHUB_REF_NAME}" = "sit" ]; then
            echo "TARGET_ORG=sit" >> $GITHUB_ENV
            echo "SF_AUTH_URL=${{ secrets.SF_SIT_AUTH_URL }}" >> $GITHUB_ENV
          elif [ "${GITHUB_REF_NAME}" = "uat" ]; then
            echo "TARGET_ORG=uat" >> $GITHUB_ENV
            echo "SF_AUTH_URL=${{ secrets.SF_UAT_AUTH_URL }}" >> $GITHUB_ENV
          else
            echo "TARGET_ORG=prod" >> $GITHUB_ENV
            echo "SF_AUTH_URL=${{ secrets.SF_PROD_AUTH_URL }}" >> $GITHUB_ENV
          fi

      # 7Ô∏è‚É£ Authenticate Salesforce
      - name: Authenticate Salesforce
        run: |
          echo "$SF_AUTH_URL" > auth.txt
          sf org login sfdx-url \
            --sfdx-url-file auth.txt \
            --alias $TARGET_ORG \
            --set-default

      # 8Ô∏è‚É£ Resolve commit range
      - name: Resolve commit range
        id: commits
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "FROM=${{ github.event.pull_request.base.sha }}" >> $GITHUB_OUTPUT
            echo "TO=${{ github.event.pull_request.head.sha }}" >> $GITHUB_OUTPUT
          else
            echo "FROM=$(git rev-parse HEAD~1)" >> $GITHUB_OUTPUT
            echo "TO=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          fi

      # 9Ô∏è‚É£ Generate delta
      - name: Generate delta
        run: |
          mkdir -p delta
          sf sgd source delta \
            --from "${{ steps.commits.outputs.FROM }}" \
            --to "${{ steps.commits.outputs.TO }}" \
            --source force-app \
            --output delta

      # üîü Check delta exists
      - name: Check delta
        run: |
          if [ ! -d "delta/force-app" ]; then
            echo "NO_DELTA=true" >> $GITHUB_ENV
            echo "No Salesforce changes detected"
          fi

      # 1Ô∏è‚É£1Ô∏è‚É£ Decide test level (FINAL SAFE LOGIC)
      - name: Decide test level
        id: tests
        if: env.NO_DELTA != 'true'
        run: |
          if [ "$TARGET_ORG" = "prod" ] && [ -f tests-to-run.txt ] && [ -s tests-to-run.txt ]; then
            TESTS=$(tr '\n' ' ' < tests-to-run.txt)
            echo "LEVEL=RunSpecifiedTests" >> $GITHUB_OUTPUT
            echo "TESTS=$TESTS" >> $GITHUB_OUTPUT
            echo "Using RunSpecifiedTests: $TESTS"
          else
            echo "LEVEL=RunLocalTests" >> $GITHUB_OUTPUT
            echo "Using RunLocalTests"
          fi

      # 1Ô∏è‚É£2Ô∏è‚É£ Validate deployment (NO ERROR GUARANTEE)
      - name: Validate deployment
        if: env.NO_DELTA != 'true'
        run: |
          if [ "${{ steps.tests.outputs.LEVEL }}" = "RunSpecifiedTests" ]; then
            sf project deploy validate \
              --source-dir delta/force-app \
              --target-org $TARGET_ORG \
              --test-level RunSpecifiedTests \
              --tests ${{ steps.tests.outputs.TESTS }}
          else
            sf project deploy validate \
              --source-dir delta/force-app \
              --target-org $TARGET_ORG \
              --test-level RunLocalTests
          fi

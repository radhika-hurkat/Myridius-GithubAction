name: Auto Promotion PR

on:
  push:
    branches:
      - qa
      - sit

permissions:
  contents: read
  pull-requests: write

jobs:
  promote:
    runs-on: ubuntu-latest

    steps:
      - name: Create Promotion PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branch = context.ref.replace('refs/heads/', '');
            let base, head, title;

            if (branch === 'qa') {
              head = 'qa';
              base = 'sit';
              title = 'Auto Promotion: QA → SIT';
            } else if (branch === 'sit') {
              head = 'sit';
              base = 'uat';
              title = 'Auto Promotion: SIT → UAT';
            } else {
              return;
            }

            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${head}`,
              base: base,
              state: 'open'
            });

            if (prs.data.length === 0) {
              await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                head: head,
                base: base,
                body: 'Auto-generated promotion PR'
              });
            }
